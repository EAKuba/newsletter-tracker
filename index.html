<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Newsletter Progress Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 1100px; }
    h1 { margin: 0 0 10px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0; }
    input { padding: 10px; border: 1px solid #ccc; border-radius: 10px; min-width: 280px; }
    button { padding: 10px 14px; border: 1px solid #ccc; border-radius: 10px; background: #fff; cursor: pointer; }
    button:hover { background: #f6f6f6; }
    .meta { color: #555; margin: 8px 0 18px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; background: #fff; }
    .handle { font-weight: 700; font-size: 18px; }
    .muted { color: #666; }
    .kvs { display: flex; gap: 14px; margin: 10px 0; flex-wrap: wrap; }
    .kv { font-size: 14px; }
    .badges { margin-top: 10px; }
    .badge { display: inline-block; padding: 4px 8px; border: 1px solid #ccc; border-radius: 999px; margin: 4px 6px 0 0; font-size: 12px; }
    .small { font-size: 12px; }
    .error { border-color: #e0a2a2; background: #fff6f6; }
    .footer { margin-top: 18px; color: #777; font-size: 12px; }
    pre { background: #f7f7f7; padding: 10px; border-radius: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Security Newsletter Progress</h1>

  <div class="row">
    <input id="search" placeholder="Search Forum ID (partial ok)..." />
    <button id="refresh">Refresh</button>
    <label class="small muted">
      <input id="showProgress" type="checkbox" />
      Show progress JSON
    </label>
  </div>

  <div class="meta">
    Updated: <strong id="updatedAt">loading…</strong>
    <span class="muted small"> (public data only — no keys)</span>
  </div>

  <div id="status" class="meta small muted"></div>
  <div id="players" class="grid"></div>

  <div class="footer">
    This page loads <code>./progress.json</code> from the same GitHub Pages site. No Google endpoints are used.
  </div>

<script>
  let DATA = null;

  async function loadData() {
    const res = await fetch('./progress.json?ts=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load progress.json: ' + res.status);
    DATA = await res.json();
    document.getElementById('updatedAt').textContent = DATA.updatedAt || '(missing)';
    render();
  }

  function render() {
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const el = document.getElementById('players');
    el.innerHTML = '';

    const seasonsOrder = Array.isArray(DATA.seasonsOrder) ? DATA.seasonsOrder : ['Season 1','Season 2','Season 3','Season 4'];
    const players = Array.isArray(DATA.players) ? DATA.players : [];

    const filtered = players.filter(p => {
      const h = (p.handle || '').toLowerCase();
      return !q || h.includes(q);
    });

    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';

    // header
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    hr.innerHTML = `
      <th style="text-align:left;border-bottom:1px solid #ddd;padding:10px;">Forum ID</th>
      <th style="text-align:right;border-bottom:1px solid #ddd;padding:10px;">Total</th>
      ${seasonsOrder.map(s => `<th style="text-align:left;border-bottom:1px solid #ddd;padding:10px;">${escapeHtml(s)}</th>`).join('')}
      <th style="text-align:left;border-bottom:1px solid #ddd;padding:10px;">Last update</th>
    `;
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    filtered.forEach(p => {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid #f0f0f0';

      const total = Number(p.totalPoints || 0);
      const seasons = p.seasons || {};

      const seasonCells = seasonsOrder.map(seasonName => {
        const s = seasons[seasonName];
        if (!s) return `<div class="muted">—</div>`;

        const cls = s.class || '';
        const pts = Number(s.points || 0);
        const badges = Array.isArray(s.badges) ? s.badges : [];
        const badgesHtml = badges.map(b => `<span class="badge">${escapeHtml(b)}</span>`).join('');

        return `
          <div><strong>${escapeHtml(cls)}</strong> · ${pts} pts</div>
          <div style="margin-top:6px">${badgesHtml || '<span class="muted">No badges</span>'}</div>
        `;
      }).join('</td><td style="vertical-align:top;padding:10px;">');

      tr.innerHTML = `
        <td style="padding:10px;vertical-align:top;"><strong>${escapeHtml(p.handle || '')}</strong></td>
        <td style="padding:10px;vertical-align:top;text-align:right;"><strong>${total}</strong></td>
        <td style="padding:10px;vertical-align:top;">${seasonCells}</td>
        <td style="padding:10px;vertical-align:top;" class="muted small">${escapeHtml(p.lastUpdate || '')}</td>
      `;

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    el.appendChild(table);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  document.getElementById('search').addEventListener('input', render);
  document.getElementById('refresh').addEventListener('click', loadData);

  loadData().catch(err => {
    document.getElementById('players').innerHTML = `<div class="card"><strong>Error</strong><div class="muted">${escapeHtml(err.message)}</div></div>`;
  });
</script>
</body>
</html>
